# Plan: Add build + assert workflow (like atmos-lang/web)

## What atmos-lang/web does

In its **test job**, the `deploy.yml` workflow does two things:

1. `bash build.sh` — runs the build script (fetches modules from GitHub, generates HTML files under `web/try/`)
2. `git diff --exit-code web/try/atmos/index.html` — asserts the checked-in HTML hasn't drifted from what the build produces

This ensures that any PR where someone edits source modules but forgets to re-run `build.sh` will **fail CI**.

## What this repo (lua-atmos/atmos) already has

- `.github/workflows/test.yml` — runs Lua tests (`tst/all.lua`)
- `build.sh` — fetches modules from GitHub and generates three HTML files:
  `lua.html`, `lua-atmos.html`, `atmos.html` (output to repo root)
- These HTML files are **not currently checked in** (not tracked by git)

## Proposed changes

### 1. Check in the generated HTML files

Run `bash build.sh` locally and commit the three generated files (`lua.html`, `lua-atmos.html`, `atmos.html`) so there's a baseline for `git diff --exit-code` to compare against.

### 2. Add a build-assert step to `.github/workflows/test.yml`

Add a new step (or a new job) in the existing workflow that:

```yaml
- name: Check generated HTML is up to date
  run: |
    bash build.sh
    git diff --exit-code lua.html lua-atmos.html atmos.html
```

This mirrors the pattern from `atmos-lang/web`:
- Run `build.sh` to regenerate the HTML
- Assert no diff — if someone changes a Lua source file but forgets to rebuild, CI catches it

### 3. Considerations

- `build.sh` uses `curl` to fetch from GitHub (raw.githubusercontent.com). The CI runner (ubuntu-latest) has `curl` pre-installed, so no extra setup is needed.
- `build.sh` fetches from a fixed version tag (`v0.5`), so builds are deterministic as long as the upstream tags don't change.
- The `.gitignore` must not exclude the three HTML files. Need to verify this.
- The build step is independent of the Lua test step, so they could run in parallel as separate jobs, or sequentially as steps in the same job (simpler).

### Summary of file changes

| File | Change |
|------|--------|
| `lua.html` | Add (generated by `build.sh`, checked in as baseline) |
| `lua-atmos.html` | Add (generated by `build.sh`, checked in as baseline) |
| `atmos.html` | Add (generated by `build.sh`, checked in as baseline) |
| `.github/workflows/test.yml` | Add build + `git diff --exit-code` step |
| `.gitignore` | Verify HTML files are not ignored (edit if needed) |
